name: Build & Publish (Windows + Linux)

on:
  push:
    branches:
      - develop
    tags:
      - "v*.*.*"      # semantic version tags, ex: v1.2.3

permissions:
  contents: write  # create tags + releases + upload assets

env:
  APP_NAME: RiskAnalysisWebUI
  ENTRY_SCRIPT: app.py

  # --- Qt GUI build ---
  QT_APP_NAME: RiskAnalysisQT
  QT_ENTRY_SCRIPT: qt_gui.py

jobs:
  prepare:
    name: Prepare version/tag
    runs-on: ubuntu-latest
    permissions:
      contents: write

    outputs:
      channel: ${{ steps.meta.outputs.channel }}
      suffix: ${{ steps.meta.outputs.suffix }}
      tag: ${{ steps.meta.outputs.tag }}
      release_name: ${{ steps.meta.outputs.release_name }}
      prerelease: ${{ steps.meta.outputs.prerelease }}
      version: ${{ steps.meta.outputs.version }}

    steps:
      - name: Checkout (full history + tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute metadata + create rc tag (develop)
        id: meta
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            VERSION="${GITHUB_REF_NAME}"
            echo "channel=release" >> "$GITHUB_OUTPUT"
            echo "suffix=" >> "$GITHUB_OUTPUT"
            echo "tag=${VERSION}" >> "$GITHUB_OUTPUT"
            echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
            echo "release_name=${VERSION}" >> "$GITHUB_OUTPUT"
            echo "prerelease=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          git fetch --tags --force

          VER="$(python -c "import re,pathlib; s=pathlib.Path('riskcalculator/__init__.py').read_text(encoding='utf-8'); m=re.search(r\"__version__\\s*=\\s*['\\\"]([^'\\\"]+)['\\\"]\", s); print(m.group(1) if m else '')")"
          if [[ -z "${VER}" ]]; then
            echo "Kunde inte hitta __version__ i riskcalculator/__init__.py" >&2
            exit 1
          fi

          BASE="v${VER}"
          LAST="$(git tag -l "${BASE}-rc*" --sort=version:refname | tail -n 1 || true)"

          # rcN räknas per version; om ingen finns -> rc0
          NEXT=0
          if [[ -n "${LAST}" && "${LAST}" =~ ^${BASE}-rc([0-9]+)$ ]]; then
            NEXT=$((BASH_REMATCH[1] + 1))
          fi

          TAG="${BASE}-rc${NEXT}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Om taggen redan finns (t.ex. re-run), skapa inte igen
          if git rev-parse -q --verify "refs/tags/${TAG}" >/dev/null; then
            echo "Tag ${TAG} finns redan, använder den."
          else
            git tag -a "${TAG}" -m "Prerelease ${TAG}"
            git push origin "${TAG}"
          fi

          echo "channel=develop" >> "$GITHUB_OUTPUT"
          echo "suffix=-SNAPSHOT" >> "$GITHUB_OUTPUT"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "version=${TAG}" >> "$GITHUB_OUTPUT"
          echo "release_name=${TAG}" >> "$GITHUB_OUTPUT"
          echo "prerelease=true" >> "$GITHUB_OUTPUT"

  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: prepare

    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-22.04]
        python: ["3.10"]

    outputs:
      channel: ${{ needs.prepare.outputs.channel }}
      suffix: ${{ needs.prepare.outputs.suffix }}
      tag: ${{ needs.prepare.outputs.tag }}
      release_name: ${{ needs.prepare.outputs.release_name }}
      prerelease: ${{ needs.prepare.outputs.prerelease }}
      version: ${{ needs.prepare.outputs.version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
          pip install pyside6

      # -------------------------
      # Build Tk/Classic app
      # -------------------------
      - name: Build with PyInstaller (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $suffix = "${{ needs.prepare.outputs.suffix }}"
          $name = "${env:APP_NAME}$suffix"
          pyinstaller --noconfirm --clean --onefile `
            --name $name `
            --add-data "templates;templates" `
            --add-data "data;data" `
            --collect-all uvicorn `
            --collect-all numpy `
            --collect-all python-multipart `
            $env:ENTRY_SCRIPT

          New-Item -ItemType Directory -Force -Path out | Out-Null
          Copy-Item "dist\$name.exe" "out\$name-windows.exe"

      - name: Build with PyInstaller (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          suffix="${{ needs.prepare.outputs.suffix }}"
          name="${APP_NAME}${suffix}"

          pyinstaller --noconfirm --clean --onefile \
            --name "${name}" \
            --add-data "templates:templates" \
            --add-data "data:data" \
            --collect-all uvicorn \
            --collect-all numpy \
            --collect-all python-multipart \
            "${ENTRY_SCRIPT}"

          mkdir -p out
          cp "dist/${name}" "out/${name}-linux"

      # -------------------------
      # Build Qt GUI
      # -------------------------
      - name: Build Qt GUI with PyInstaller (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $suffix = "${{ needs.prepare.outputs.suffix }}"
          $name = "${env:QT_APP_NAME}$suffix"

          pyinstaller --noconfirm --clean --onefile `
            --name $name `
            --add-data "templates;templates" `
            --add-data "data;data" `
            --collect-all PySide6 `
            --collect-all shiboken6 `
            --collect-submodules PySide6 `
            $env:QT_ENTRY_SCRIPT

          New-Item -ItemType Directory -Force -Path out | Out-Null
          Copy-Item "dist\$name.exe" "out\$name-windows.exe"

      - name: Build Qt GUI with PyInstaller (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          suffix="${{ needs.prepare.outputs.suffix }}"
          name="${QT_APP_NAME}${suffix}"

          pyinstaller --noconfirm --clean --onefile \
            --name "${name}" \
            --add-data "templates:templates" \
            --add-data "data:data" \
            --collect-all PySide6 \
            --collect-all shiboken6 \
            --collect-submodules PySide6 \
            "${QT_ENTRY_SCRIPT}"

          mkdir -p out
          cp "dist/${name}" "out/${name}-linux"

      - name: Upload workflow artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-${{ runner.os }}${{ needs.prepare.outputs.suffix }}
          path: out/*
          if-no-files-found: error

  publish:
    name: Publish GitHub Release (assets)
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts (debug)
        shell: bash
        run: |
          find artifacts -type f -maxdepth 4 -print

      - name: Create/Update Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.build.outputs.tag }}
          name: ${{ needs.build.outputs.release_name }}
          prerelease: ${{ needs.build.outputs.prerelease }}
          generate_release_notes: true
          target_commitish: ${{ github.ref_type == 'tag' && github.sha || github.ref_name }}
          files: |
            artifacts/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
